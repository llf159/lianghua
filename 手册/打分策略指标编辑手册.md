# 打分策略/指标编辑手册

## 1. 编辑入口与生效方式

- **方式A：在 UI 内编辑 JSON**（推荐）
  - 入口：「规则编辑（JSON）」分栏，直接编辑 `prescreen`（初选）与 `rules`（打分）两组，点「✅ 校验并应用到引擎」立即生效（仅当次会话），也可导出/导入 `rules.json`。 
- **方式B：改 `config.py`**
  - 直接编辑 `SC_PRESCREEN_RULES` 与 `SC_RULES`。

> 说明：`SC_HIDE_FORMULA = True` 仅影响**明细 JSON 是否直接包含表达式**；UI 里勾选“显示规则 when 表达式”时，会从**当前规则集**映射展示，不依赖 JSON 里是否保存公式。 

## 2. 规则对象的通用字段

每条规则（不论在 `prescreen` 还是 `rules`）可用：

- `name`：名称（字符串）
- `timeframe`：周期，`"D" | "W" | "M"`，默认 `"D"`。
- `window`：窗口长度（整数）
- `when`：**TDX 风格**表达式，见第 5 节。也可用 `clauses`（子句数组）替代。
- `scope`：命中范围/累计方式（见第 3 节）
- `points`：命中加/减分（浮点/整数）。`RECENT` 类规则用 `dist_points`（见下）。
- `explain`：这条规则在命中时的“理由文案”，用于 UI 摘要。
- `show_reason`：是否把 `explain` 展示在摘要，默认 `True`。可设 `false` 隐藏。
- `as`：命中后“理由”的分桶：`"highlight" | "drawback" | "opportunity" | "auto"`（默认 `auto` 按分值正负进优点/缺点）。

**跨周期/多条件**：用 `clauses` 数组，每个子句都有自己的 `timeframe/window/when/scope`。在**初选**里，多个子句需要**全部为真**才算命中该规则（AND）。

## 3. scope 的写法与语义

引擎支持以下几类：

- **布尔类（普通打分）**
  - `LAST`：只看窗口内最后一根是否为真。
  - `ANY`：窗口内任意一根为真。
  - `ALL`：窗口内全部为真。
  - `COUNT>=k`：窗口内为真的根数 **≥ k**。
  - `CONSEC>=m`：窗口内**连续**为真天数 **≥ m**。
     （这些统一走 `_scope_hit` 评估）
- **逐K累计类（计数乘分）**
  - `EACH` / `PERBAR` / `EACH_TRUE`：对窗口内**每根**逐根判断，累计 `True` 次数 `cnt`，加分为 `points * cnt`。
    - 若是 `clauses` 组合，要求所有子句的 `timeframe/window` 一致，然后先逐K **AND** 融合再计数。 
- **最近距离类（按“距今多少天”计分）**
  - `RECENT`（同义：`DIST` / `NEAR`）：找出**最近一次**满足 `when` 的位置，得到 lag（距参考日 0/1/2…天），再按 `dist_points` 规则给分。
  - `dist_points` 支持两种写法（可混用）：
    - 列表：`[[min, max, points], ...]`
    - 字典：`[{"min":0,"max":5,"points":30}, ...]`
       （内部用 `_recent_points` 实现，返回 `add, lag`）

## 4. 初选（Prescreen）

- 放在 `SC_PRESCREEN_RULES` 中；若命中带 `hard_penalty: true` 的规则则**直接淘汰**（写黑名单理由）。规则支持 `clauses` 组合（AND）。
- 字段：`name/timeframe/window/when/scope/hard_penalty/reason/clauses`。

## 5. 表达式语法（TDX 风格 → 引擎）

### 5.1 变量（列名/别名）

- 预置映射（不区分大小写）：`C/CLOSE`、`O/OPEN`、`H/HIGH`、`L/LOW`、`V/VOL`、`AMOUNT`、`J`（KDJ）、`VR`、`Z_SLOPE`、`BBI`、`BUPIAO_SHORT`、`BUPIAO_LONG` 等。 
- 自动挂载：**当前 df 的任意列**会被注入到上下文里（原名与全大写两个别名），只要是合法标识符即可直接用。
- 对指数注入的特征（需在 `config.py` 配置基准）：
  - `IDX_<CODE>_CLOSE`，`RET_<CODE>`
  - `RS_<CODE>_<W>`、`EXRET_<CODE>`、`EXRET_SUM_<CODE>_<W>`
  - `BETA_<CODE>_<W>`、`CORR_<CODE>_<W>`（可直接出现在表达式里） 

### 5.2 函数

- 预置：`REF, MA, EMA, SMA, SUM, HHV, LLV, STD, ABS, MAX, MIN, IF, COUNT, CROSS, BARSLAST`。
- 额外：`SAFE_DIV(a,b)`（安全除法，分母≈0自动保护），`RSV(C,H,L,n)`。
- 逻辑：支持 `AND/OR/NOT`、`&&/||/!`；`=` 会被当作 `==` 处理。位运算安全括号自动包裹。 

### 5.3 量价/排名相关的运行时函数（在 EXTRA_CONTEXT 注入）

- `RANK_VOL(N, K=None)`：近 `N` 日**成交量**由小到大名次（名次越小越“量小”）。
- `RANK_RET(N, K=None, side='up'|'down')`：近 `N` 日涨跌幅名次（`side='up'` 代表涨幅榜；`'down'` 代表跌幅榜）。
- `RANK_MATCH_COEF(N=None, K=None)`：量价匹配系数（0~1）。
   以上均在 `score_engine` 运行时注入到 `tdx_compat.EXTRA_CONTEXT`，表达式里可直接调用。 

> 小贴士：表达式里可直接用 `CROSS(diff,0)`、`C>MA(C,20)`、`REF((H-MAX(O,C))/(H-L+0.01)>=0.4,1) AND (H<=REF(H,1))` 之类写法；`CROSS` 使用的是**索引对齐**的安全实现。