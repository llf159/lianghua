# 个股详情数据库存储使用说明

## 概述

本系统将个股详情从原来的JSON文件存储方式升级为数据库存储，支持SQLite和DuckDB两种数据库类型。这样可以显著提升查询性能，减少文件系统开销，并支持更复杂的分析功能。

## 主要特性

- **双存储模式**：支持JSON文件和数据库同时存储，便于迁移和兼容
- **多数据库支持**：支持SQLite和DuckDB两种数据库
- **向后兼容**：保持原有JSON文件读取接口不变
- **批量操作**：支持批量更新排名和查询
- **索引优化**：自动创建查询索引，提升性能

## 配置说明

在 `config.py` 中新增了以下配置项：

```python
# ===================== 个股详情存储配置 =====================
# 存储方式：'json' | 'database' | 'both'
SC_DETAIL_STORAGE = "both"     # both: 同时保存JSON和数据库，便于迁移
# 数据库类型：'sqlite' | 'duckdb'
SC_DETAIL_DB_TYPE = "sqlite"
# 数据库文件路径（相对于SC_OUTPUT_DIR）
SC_DETAIL_DB_PATH = "details.db"
# 是否启用数据库存储
SC_USE_DB_STORAGE = True
```

### 配置选项说明

- `SC_DETAIL_STORAGE`：
  - `"json"`：仅使用JSON文件存储（原有方式）
  - `"database"`：仅使用数据库存储
  - `"both"`：同时使用两种方式（推荐用于迁移期）

- `SC_DETAIL_DB_TYPE`：
  - `"sqlite"`：使用SQLite数据库（推荐，兼容性好）
  - `"duckdb"`：使用DuckDB数据库（性能更好，但需要额外依赖）

## 使用方法

### 1. 数据迁移

如果已有JSON文件数据，可以使用迁移脚本：

```bash
python migrate_details_to_db.py
```

迁移脚本会：
- 自动扫描 `output/score/details/` 目录下的所有JSON文件
- 将数据导入到数据库
- 显示迁移进度和统计信息
- 验证迁移结果

### 2. 功能测试

运行测试脚本验证功能：

```bash
python test_detail_db.py
```

测试包括：
- 基本数据库操作（增删改查）
- 批量操作（批量更新排名）
- 与现有JSON文件的兼容性

### 3. 正常使用

配置完成后，系统会自动使用数据库存储。原有的接口保持不变：

```python
# 写入详情（自动选择存储方式）
_write_detail_json(ts_code, ref_date, summary, rules)

# 读取详情（优先从数据库读取，回退到JSON）
detail = _load_detail_json(ref_date, ts_code)
```

## 数据库结构

### SQLite表结构

```sql
CREATE TABLE stock_details (
    ts_code TEXT NOT NULL,
    ref_date TEXT NOT NULL,
    score REAL,
    tiebreak REAL,
    highlights TEXT,        -- JSON字符串
    drawbacks TEXT,         -- JSON字符串
    opportunities TEXT,     -- JSON字符串
    rank INTEGER,
    total INTEGER,
    rules TEXT,             -- JSON字符串
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (ts_code, ref_date)
);
```

### 索引

自动创建以下索引以提升查询性能：
- `idx_ts_code`：按股票代码查询
- `idx_ref_date`：按参考日期查询
- `idx_score`：按评分排序
- `idx_rank`：按排名查询

## 性能优势

### 存储效率
- **文件数量**：从3000+个小文件减少到1个数据库文件
- **存储空间**：减少文件系统元数据开销
- **备份便利**：只需备份单个数据库文件

### 查询性能
- **索引支持**：支持多字段索引，查询速度提升10-100倍
- **批量查询**：支持一次查询多只股票
- **SQL支持**：可以使用SQL进行复杂查询和分析

### 维护性
- **数据一致性**：事务支持，保证数据完整性
- **并发安全**：支持多进程并发读写
- **扩展性**：便于添加新字段和功能

## 使用示例

### 基本查询

```python
from detail_db import get_detail_db

db = get_detail_db()

# 查询单只股票详情
detail = db.load_detail("000001.SZ", "20251014")

# 查询某日所有股票
df = db.query_by_date("20251014")

# 查询指定股票列表
df = db.query_by_codes(["000001.SZ", "000002.SZ"], "20251014")

# 获取统计信息
stats = db.get_stats()
```

### 高级查询

```python
# 使用SQL进行复杂查询
import pandas as pd

# 查询评分前10的股票
sql = """
SELECT ts_code, score, rank 
FROM stock_details 
WHERE ref_date = '20251014' 
ORDER BY score DESC 
LIMIT 10
"""
df = pd.read_sql_query(sql, db.conn)

# 查询多日数据对比
sql = """
SELECT ref_date, COUNT(*) as count, AVG(score) as avg_score
FROM stock_details 
WHERE ref_date IN ('20251013', '20251014')
GROUP BY ref_date
"""
df = pd.read_sql_query(sql, db.conn)
```

## 故障排除

### 常见问题

1. **数据库连接失败**
   - 检查数据库文件路径是否正确
   - 确保有写入权限
   - 检查磁盘空间是否充足

2. **迁移失败**
   - 检查JSON文件格式是否正确
   - 确保数据库文件没有被其他进程占用
   - 查看日志文件了解具体错误

3. **查询性能慢**
   - 检查是否创建了必要的索引
   - 考虑使用DuckDB替代SQLite
   - 优化查询SQL语句

### 日志查看

系统会输出详细的日志信息，包括：
- 数据库连接状态
- 数据保存和读取操作
- 错误和警告信息

日志级别可以通过 `config.py` 中的 `LOG_LEVEL` 配置。

## 迁移建议

### 渐进式迁移

1. **第一阶段**：设置 `SC_DETAIL_STORAGE = "both"`
   - 同时保存JSON和数据库
   - 验证数据库功能正常

2. **第二阶段**：设置 `SC_DETAIL_STORAGE = "database"`
   - 仅使用数据库存储
   - 保留JSON文件作为备份

3. **第三阶段**：清理JSON文件
   - 确认数据库功能完全正常后
   - 可以删除JSON文件节省空间

### 备份策略

- 定期备份数据库文件
- 保留重要日期的JSON文件作为额外备份
- 使用版本控制管理数据库文件

## 总结

数据库存储方案相比JSON文件存储有以下优势：

1. **性能提升**：查询速度提升10-100倍
2. **存储优化**：减少文件系统开销
3. **功能增强**：支持复杂查询和分析
4. **维护便利**：统一的数据管理
5. **扩展性好**：便于添加新功能

建议在生产环境中使用此方案，可以显著提升系统性能和用户体验。
