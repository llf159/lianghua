# 策略语法检查器使用说明

## 概述

策略语法检查器用于自动检查本地Python策略文件的语法错误、必填字段、表达式有效性等。主要功能：
1. **自动文件定位** - 自动扫描并定位策略文件
2. **语法验证** - 验证策略规则的语法和字段有效性
3. **表达式检查** - 检查TDX表达式的正确性

## 功能详解

### 自动策略文件检查

**用途**：自动检查本地Python策略文件的语法错误、必填字段、表达式有效性等

**使用方法**：
1. 系统会自动扫描并定位策略文件
2. 如果找到多个文件，会显示选择列表（默认选择第一个）
3. 如果只找到一个文件，会直接显示文件路径
4. 点击"🔍 检查语法"按钮开始验证

**检查内容**：
- ✅ Python文件语法正确性
- ✅ 策略列表结构正确性（RANKING_RULES、FILTER_RULES等）
- ✅ 每个规则的字段和表达式
- ✅ 必填字段完整性（如`when`字段）
- ✅ 字段类型正确性（如`timeframe`、`window`、`points`等）
- ✅ 表达式语法正确性
- ✅ 支持的函数和变量
- ✅ 缺失的数据列和指标
- ✅ 指标依赖关系

**自动搜索路径**：
- `strategies_repo.py` - 当前目录下的主要策略文件
- `strategies/strategies_repo.py` - strategies目录下的文件
- `**/strategies_repo.py` - 递归搜索所有子目录

**特点**：
- 🔍 **自动定位**：无需手动选择，系统自动找到策略文件
- 📁 **智能搜索**：按优先级搜索多个可能的位置
- 🎯 **去重处理**：自动去除重复文件，避免混淆
- 📋 **默认选择**：自动选择最合适的文件作为默认选项

## 验证结果说明

### 错误类型

1. **🚨 错误** - 必须修复的问题
   - 缺少必填字段
   - 字段类型错误
   - 表达式语法错误
   - 不支持的函数或变量

2. **⚠️ 警告** - 可能影响功能的问题
   - 字段值超出合理范围
   - 不推荐的配置
   - 潜在的性能问题

3. **💡 建议** - 改进建议
   - 添加缺失的说明字段
   - 使用更安全的函数
   - 优化表达式复杂度

### 常见问题及解决方案

#### 1. 表达式错误
**问题**：`when`表达式语法错误
**解决**：
- 检查括号配对
- 确认函数名正确（如`MA`、`CROSS`等）
- 使用`SAFE_DIV`避免除零错误

#### 2. 字段类型错误
**问题**：`points`字段类型错误
**解决**：
- 确保`points`是数字类型
- 检查`window`是正整数
- 确认`timeframe`是支持的周期

#### 3. 缺失指标
**问题**：使用了未注册的指标
**解决**：
- 检查指标名称拼写
- 确认指标已在`indicators.py`中注册
- 使用内置指标如`J`、`VR`等

## 支持的字段

### 必填字段
- `when` - 条件表达式（排名/筛选/持仓策略）
- `check` - 检查表达式（模拟策略）

### 可选字段
- `name` - 规则名称
- `timeframe` - 时间周期（D/W/M/60MIN）
- `window` - 回看窗口（正整数）
- `scope` - 命中口径（LAST/ANY/ALL/EACH等）
- `points` - 分数（数字）
- `explain` - 说明文字
- `gate` - 前置门槛
- `clauses` - 多子句组合

## 支持的表达式函数

### 基础函数
- `MA(x, n)` - 移动平均
- `EMA(x, n)` - 指数移动平均
- `HHV(x, n)` - 最高值
- `LLV(x, n)` - 最低值
- `REF(x, n)` - 引用前N期
- `CROSS(a, b)` - 交叉函数

### 统计函数
- `COUNT(cond, n)` - 计数
- `SUM(x, n)` - 求和
- `STD(x, n)` - 标准差

### 安全函数
- `SAFE_DIV(a, b)` - 安全除法
- `MAX(a, b)` - 最大值
- `MIN(a, b)` - 最小值

## 最佳实践

1. **使用说明文字**：为每个规则添加`name`和`explain`字段
2. **安全除法**：使用`SAFE_DIV`避免除零错误
3. **合理窗口**：设置合适的`window`值（通常5-100）
4. **表达式简化**：避免过于复杂的表达式
5. **测试验证**：使用语法检查验证规则正确性

## 故障排除

如果遇到问题，请检查：
1. JSON格式是否正确
2. 必填字段是否完整
3. 表达式语法是否正确
4. 使用的函数是否支持
5. 字段类型是否正确

通过使用这些功能，您可以更轻松地编写、验证和测试量化策略规则。
