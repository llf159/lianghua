#  策略字段与表达式参考

> 适用于 `score_ui.py` 里“策略测试器（单条规则）”的 JSON 规则；也同样适用于 `config.py` 中 `SC_RULES` 的写法。

---

## 1) 最小可用模板（**必填** / **可选**）

```json
{
  "timeframe": "D",                // 可选，默认 "D"（日线）
  "window": 60,                    // 可选，默认 SC_LOOKBACK_D（config 里默认 60）
  "when": "C > MA(C, 20)",         // ✅ 必填：TDX 风格表达式（见下）
  "scope": "ANY",                  // 可选，默认 "ANY"
  "points": 0,                     // 可选：命中加/减分（默认 0）
  "explain": "示例说明"             // 可选：规则说明文字
}
```
> 说明：`when` 至少要提供一个（或用 `clauses` 多子句替代），其余字段都有默认值。

---

## 2) 字段一览

| 字段 | 类型 | 是否必填 | 取值 / 说明 |
|---|---|---|---|
| `name` | str | 可选 | 规则名，仅用于展示。 |
| `timeframe` | str | 可选 | `"D" / "W" / "M"`，默认 `"D"`（日、周、月线）。 |
| `window` | int | 可选 | 回看窗口条数，默认 `SC_LOOKBACK_D`（config 默认 60）。 |
| `when` | str | **必填** | 条件表达式（TDX 风格，见 §5）。可与 `scope` 组合决定“命中”语义。若使用 `clauses`，每个子句也需要 `when`。 |
| `scope` | str | 可选 | 命中口径，默认 `"ANY"`。详见 §3。 |
| `points` | number | 可选 | 命中时加/减分，默认 `0`。`scope="EACH"` 时会对每条命中累加。 |
| `explain` | str | 可选 | 规则解释文本，用于明细展示。 |
| `show_reason` | bool | 可选 | 是否把该规则的 `explain` 纳入“理由”列表，默认 `True`。 |
| `as` | str | 可选 | 分类标签：`"opportunity"`（机会）、`"highlight"`（高亮）、`"drawback"`（缺点）、或 `"auto"`（默认，由系统决定）。这些标签可被 `ANY_TAG*/TAG_*` 系列函数使用（§5.4）。 |
| `gate` / `trigger` / `require` | str / dict / list | 可选 | **前置门槛**。命中该门槛后才判定主体规则。可写成一个表达式字符串，或一个“子规则对象”，或“子句数组”。未显式给出时默认 `scope="LAST"`，并继承外层 `timeframe/window`。 |
| `clauses` | list | 可选 | 多子句 **AND** 组合（跨周期时需所有子句的 `timeframe/window` 一致）。详见 §4。 |
| `dist_points` / `distance_points` | list | 可选 | 仅当 `scope` 为 `RECENT`/`DIST`/`NEAR` 使用：按“最近一次命中的距离（lag，单位=该周期K线条数）”分段给分。详见 §3.3。 |

---

## 3) `scope`（命中口径）

### 3.1 基本口径
- `LAST`：仅看窗口内 **最后一根** 是否满足。  
- `ANY`：窗口内 **任意一根** 满足即命中。  
- `ALL`：窗口内 **全部** 满足才命中。  
- `COUNT>=k`：窗口内满足的 **次数** ≥ k。  
- `CONSEC>=m`：窗口内存在 **连续 m 天** 为 True。  

### 3.2 连续子窗
- `ANY_n`：在长度为 *n* 的任意 **连续子窗** 中至少 1 天为 True。  
- `ALL_n`：在长度为 *n* 的任意 **连续子窗** 中 **每天** 都为 True（等价“存在长度 n 的连续 True 段”）。  

> 以上口径均对 `when` 的布尔序列进行统计；内部实现已处理缺失为 False。

### 3.3 最近命中打分（`RECENT` / `DIST` / `NEAR`）
将 `scope` 设为 `RECENT`（或同义：`DIST`/`NEAR`）时，不直接用 `points`，而是根据 **最近一次命中的距离 `lag`**（距离窗口右端的 K 数）在 `dist_points` 表中查分：

- `dist_points` 支持两种写法：
  1) 区间三元组：`[[min, max, points], ...]`  
  2) 显式对象：`[{"min":0,"max":5,"points":+10}, ...]`  
- 运行时将计算窗口内最近一次 `when=True` 的位置，得到 `lag`，并按区间匹配到对应 `points`。无法命中时不加分。

示例：
```json
{
  "scope": "RECENT",
  "dist_points": [[0,5,+20],[6,10,+10],[11,20,+5]]
}
```

---

## 4) 多子句 `clauses`

用于“跨周期 AND 组合”的写法。规则：

- 每个子句都是一个小规则对象：需要 `timeframe/window/when`/`scope`。  
- **所有子句的 `timeframe` 与 `window` 必须一致**；系统会 **逐K合并（AND）** 后再依据 `scope` 统计命中/次数。  
- 可与 `gate` 联用：先判 `gate`，再判合并后的主体。

示例：
```json
{
  "name": "D突破+W多头",
  "clauses": [
    {"timeframe":"D","window":40,"when":"C>HHV(H,40) AND V>1.5*MA(V,20)","scope":"ANY"},
    {"timeframe":"W","window":20,"when":"MA(C,5)>MA(C,10)","scope":"LAST"}
  ],
  "points": +8,
  "explain": "日线放量突破且周线均线多头排列"
}
```

---

## 5) 表达式语法（TDX 兼容）

### 5.1 变量（大小写不敏感）
- 价格/量：`C/Close` 收盘，`O/Open` 开盘，`H/High` 最高，`L/Low` 最低，`V/Vol` 成交量，`AMOUNT` 成交额。  
- 常用指标列（若缺会自动兜底）：`J`（KDJ 的 J 值），`VR`（量比，自动按 26 日均量兜底）。  
- 自定义/合并产物：`z_slope`、`bbi`、`bupiao_short`、`bupiao_long` 等（若存在于数据列即可直接用）。

### 5.2 函数（精选）
- 统计/滑窗：`MA(x,n)`、`EMA(x,n)`、`SMA(x,n,m)`、`SUM(x,n)`、`STD(x,n)`、`HHV(x,n)`、`LLV(x,n)`、`REF(x,n)`、`BARSLAST(cond)`、`COUNT(cond,n)`、`CROSS(a,b)`、`ABS/MAX/MIN`、`SAFE_DIV(a,b)`、`RSV(C,H,L,n)`。
- 时序分位/名次：`TS_PCT(x,n)`（近 n 天分位，0~1）、`TS_RANK(x,n)`（近 n 天名次，1~n）。
- 横截面名次：`RANK_VOL(N,K?)`、`RANK_RET(N,K?, side='up'|'down')`、`RANK_MATCH_COEF(N,K?)`。

### 5.3 逻辑与比较
- 逻辑：`AND`、`OR`、`NOT`（可写成 `&`、`|`、`~`）。  
- 比较：`> >= < <= == !=`。单等号 `=` 会被自动规范为 `==`。  
- 赋值与多语句：支持 `X := ...;` 分号分隔；最后一个表达式或名为 `sig/LAST_EXPR` 的变量会作为条件输出。

### 5.4 标签函数（与 `as` 规则联动）
- `ANY_TAG("关键词|正则", shift=0)`：根据列名或 `as` 规则生成的标签，模糊匹配并 **OR** 聚合，`shift=1` 表示“引用昨日”。  
- `TAG_HITS("pattern", shift=0)`：返回整型命中次数序列，可与阈值比较。  
- `ANY_TAG_AT_LEAST("pattern", k, shift=0)` / 及其昨日版本。

> 这些函数会在当前滚动窗口内对齐索引，并可读取通过 `as` 分类计算出的 `CUSTOM_TAGS`。

---

## 6) `gate` / `trigger` / `require`（前置门槛）

- 写法：可以是一个字符串表达式（等价一个子规则），也可以是一个 **子规则对象** 或 **子句数组**。  
- 默认：若没写 `timeframe/window/scope`，门槛会 **继承外层**，并把 `scope` 视为 `"LAST"`（只看门槛在窗口的最后一根是否成立）。  
- 流程：先判 `gate` 命中，再判主体规则；若 `gate` 未通过，主体不加分。

示例：
```json
{
  "name": "破趋势",
  "timeframe": "D",
  "window": 2,
  "when": "C <= duokong_long",
  "gate": "O > duokong_long",     // 仅当当日高于趋势时，才认可“跌破”
  "scope": "LAST",
  "points": -20
}
```

---

## 7) 常见示例

- **连续条件**（三连阳）：
```json
{
  "timeframe":"D","window":20,"when":"C>MA(C,20)","scope":"CONSEC>=3","points":+4,"explain":"连续3天收盘站上MA20"
}
```

- **跨周期 AND 组合**（日线突破 + 周线多头）：见 §4 示例。

- **最近命中给分**（金叉越近分越高）：
```json
{
  "timeframe":"D","window":25,"when":"CROSS(duokong_short,duokong_long)","scope":"RECENT","dist_points":[[0,5,30],[6,20,20]],"explain":"多空金叉"
}
```

---

## 8) 注意事项 / 最佳实践

- 多子句 `clauses` 当前**不支持**在同一规则里混用不同 `timeframe/window`（需保持一致）。
- 使用 `J/VR` 时若源数据缺列，系统会自动兜底计算；默认把缺失当作 `False` 处理。
- `scope="EACH"`/`PERBAR`：对每个满足 `when=True` 的 K 线进行逐条计数并叠加 `points`。适用于“日内/逐K加权”的场景。

