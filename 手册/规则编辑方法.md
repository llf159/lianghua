# 量化策略规则编辑手册

适用范围：`score_ui.py` 的“策略测试器（单条规则）/规则编辑辅助工具”，`strategies_repo.py` 中的各策略列表（RANKING/FILTER/OPPORTUNITY/POSITION/PREDICTION），以及 `config.py` 的 `SC_RULES`。规则语法兼容通达信风格，并结合本项目的指标/标签/模拟能力。

## 1. 最小模板

```json
{
  "timeframe": "D",
  "score_windows": 60,
  "when": "C > MA(C, 20)",
  "scope": "ANY",
  "points": 0,
  "explain": "示例说明"
}
```

- `when` 必填（除非用 `clauses`），`window` 字段已废弃，请用 `score_windows`。  
- 可在 UI 的“规则编辑辅助工具”中生成模板并验证字段。

## 2. 字段全览

| 字段 | 用途/说明 | 默认 |
| --- | --- | --- |
| `name` | 规则名称，仅用于展示/日志 | - |
| `timeframe` | `"D"`/`"W"`/`"M"`/`"60MIN"` | `"D"` |
| `score_windows` | 计分窗口长度 | `60` |
| `when` | 主体表达式（TDX 语法） | - |
| `scope` | 命中口径，见第 3 节 | `"ANY"` |
| `points` | 命中时加减分（可为负） | `0` |
| `explain` | 文字说明 | - |
| `show_reason` | 是否纳入“理由”列表 | `true` |
| `as` | 分类标签：`opportunity/highlight/drawback/auto` | `"auto"` |
| `gate`/`trigger`/`require` | 前置门槛，三者等价，可写字符串/子规则/子句数组 | - |
| `clauses` | 多子句 AND 组合，替代外层 `when` | - |
| `dist_points` | 距离分段给分，仅配合 `RECENT/DIST/NEAR` | - |
| `reason` | FILTER 用：命中原因描述 | - |
| `hard_penalty` | FILTER 用：硬惩罚分 | - |
| `check`/`scenario` | PREDICTION 用：表达式与虚拟日配置 | - |

## 3. 命中口径（scope）

| 口径 | 说明 | 场景 |
| --- | --- | --- |
| `LAST` | 仅看窗口最后一根 | 今日是否站上线 |
| `ANY` | 任意一根为 True 即命中 | 近期是否有涨停 |
| `ALL` | 窗口内全部 True | 连续上涨 |
| `EACH` | 窗口内每根命中都加分 | 逐 K 加分 |
| `COUNT>=k` | 命中次数≥k | 近20天涨停≥3次 |
| `CONSEC>=m` | 存在连续 m 天 True | 连涨/连跌 |
| `ANY_n` / `ALL_n` | 任意长度为 n 的子窗中，任意/全部命中 | “近10天任意5天” |
| `RECENT`/`DIST`/`NEAR` | 最近一次命中距离分段给分，需 `dist_points` | 金叉越近分越高 |

`dist_points` 写法：`[[min,max,points], ...]` 或 `[{ "min":0,"max":5,"points":20}, ...]`，距离单位为 K 线数。

## 4. 多子句（clauses）

- 每个子句都是完整规则：需 `timeframe/score_windows/when/scope`。  
- 所有子句的周期与窗口必须一致，系统逐 K 做 AND，再按 `scope` 统计。  
- 与 `gate/trigger/require` 可叠加；使用 `clauses` 时外层可不写 `when`。

示例（跨周期组合）：

```json
{
  "name": "日线突破+周线多头",
  "clauses": [
    {"timeframe":"D","score_windows":40,"when":"C>HHV(H,40) AND V>1.5*MA(V,20)","scope":"ANY","explain":"日线放量突破40日高点"},
    {"timeframe":"W","score_windows":20,"when":"MA(C,5)>MA(C,10)","scope":"LAST","explain":"周线多头排列"}
  ],
  "points": 8,
  "explain": "日线放量突破且周线均线多头"
}
```

## 5. 前置门槛（gate/trigger/require）

- 三个字段等价，先判门槛再判主体；未显式指定周期/窗口时继承外层，默认 `scope="LAST"`。  
- 写法：字符串、子规则对象、子句数组。可多层嵌套。

示例（字符串门槛）：

```json
{
  "timeframe": "D",
  "score_windows": 20,
  "when": "CROSS(MA(C,5), MA(C,20))",
  "gate": "V > 2*MA(V,20)",
  "scope": "LAST",
  "points": 20
}
```

示例（子句数组门槛）：

```json
{
  "when": "C > duokong_long",
  "gate": [
    {"when": "V > MA(V,20)", "scope": "ANY"},
    {"when": "O > duokong_long", "scope": "LAST"}
  ],
  "scope": "LAST",
  "points": -10,
  "explain": "放量+曾站上趋势才认定跌破"
}
```

## 6. 表达式与函数

- 价格/量别名：`O/H/L/C/V/AMOUNT`；DataFrame 数值列自动注入上下文，大小写不敏感。  
- 常用函数：`MA/EMA/SMA/HHV/LLV/SUM/STD/COUNT/CROSS/REF/BARSLAST/SAFE_DIV/ABS/MAX/MIN/IF`。  
- 排名/百分位：`TS_RANK(x,n)`、`TS_PCT(x,n)`。  
- 标签：`ANY_TAG(pattern, shift=0)`、`TAG_HITS(pattern, shift=0)`、`ANY_TAG_AT_LEAST(pattern,k,shift=0)`；`YDAY_` 前缀取昨日。  
- DIFF/KDJ 工具：`GET_LAST_DIFF_HIGH_PRICE`、`GET_LAST_DIFF_HIGH_VALUE`、`REVERSE_PRICE_TO_DIFF`、`FIND_LAST_LOWEST_J`、`GET_LAST_CONDITION_PRICE`。  
- 多语句：用分号 `;` 赋值：`HH:=HHV(H,20); SIG:=(C>HH) AND V>MA(V,20); SIG;`

## 7. 指标与数据列

- 注册指标见 `indicators.py:REGISTRY`：`kdj(j)`、`volume_ratio(vr)`、`volume_ratio_prev(vr_prev)`、`bbi(bbi)`、`rsi(rsi)`、`DIFF(diff)` 等。  
- 解析时自动扫描表达式提取所需输出列；TDX 计算失败自动回退 Python，前 `warmup` 行置 `None`，并按 `out` 小数位 round。  
- 自定义列：若数据源有自定义列（如 `z_slope`、`bbi`），直接写列名或别名即可被注入。

## 8. 常用策略示例

### 排名/筛选（score_ui → RANKING/FILTER）

```json
{
  "name": "放量突破",
  "timeframe": "D",
  "score_windows": 20,
  "when": "C > HHV(H,20) AND V > 1.5*MA(V,20)",
  "scope": "LAST",
  "points": 15,
  "explain": "放量突破20日高点",
  "as": "opportunity"
}
```

```json
{
  "name": "近20天涨停≥3次",
  "timeframe": "D",
  "score_windows": 20,
  "when": "C >= REF(C,1)*1.095",
  "scope": "COUNT>=3",
  "points": 20,
  "explain": "至少3次涨停"
}
```

### 距离打分（RECENT/DIST/NEAR）

```json
{
  "name": "金叉越近分越高",
  "timeframe": "D",
  "score_windows": 25,
  "when": "CROSS(MA(C,5), MA(C,20))",
  "scope": "RECENT",
  "dist_points": [[0,5,30],[6,20,20],[21,40,10]],
  "explain": "越近分越高"
}
```

### 逐 K 累加

```json
{"name":"每根阳线加分","timeframe":"D","score_windows":10,"when":"C>O","scope":"EACH","points":2}
```

### 标签联动

```json
{"name":"机会标签联动","timeframe":"D","score_windows":20,"when":"ANY_TAG('突破|涨停',shift=0) AND C>MA(C,20)","scope":"ANY","points":15,"as":"opportunity"}
```

### 买点/持仓（OPPORTUNITY/POSITION）

```json
{
  "name": "止盈—浮盈≥20%且回落",
  "when": "UNREAL_PNL >= 0.2 AND CLOSE < MA(CLOSE,5)",
  "explain": "浮盈≥20%回撤至5日线下"
}
```

买点可选择：按日期取价 / 从 `OPPORTUNITY_POLICIES` 取价 / 手动输入；持仓可勾选“基于明日虚拟日检查”复用模拟场景。

### 模拟（PREDICTION）

```json
{
  "name": "放量突破近20日高点",
  "check": "HH:=HHV(H,20); VR:=SAFE_DIV(V,MA(V,20)); SIG:=(C>HH) AND (VR>=1.5);",
  "scenario": {
    "mode": "gap_then_close_pct",
    "gap_pct": -0.5,
    "pct": 2.0,
    "hl_mode": "atr_like",
    "atr_mult": 1.2,
    "vol_mode": "mult",
    "vol_arg": 1.5,
    "lock_higher_than_open": true,
    "warmup_days": 80
  }
}
```

## 9. 最佳实践

1. 窗口/周期一致：多子句不混用不同 `timeframe/score_windows`。  
2. 分层思路：复杂条件用 `gate/trigger/require` 先筛，再判主体；避免巨长单句。  
3. 安全除法：用 `SAFE_DIV` 避免除零；边界数据注意空值。  
4. 说明齐全：`name/explain` 填好，方便日志与 UI；标签用 `as` 管理。  
5. 废弃字段：不要再用 `window`。  
6. 工具优先：写完规则先在规则编辑器验证，再跑语法检查器；缺列/语法问题会有提示。  
7. 指标管理：新增指标必须注册到 `indicators.py`，设置 warmup 与精度；数据不够 warmup 时前段会置空。  
8. 调试技巧：拆小规则逐个验证；查看日志；在表达式中直接计算指标以减少列依赖。
9. 数据前置：规则依赖的行情/指标列来自 `download.py` 下载及指标计算（支持自动 warmup）；缺列时要么补抓数据要么在表达式中现场计算。

## 10. 常见问题

- **表达式报列不存在**：确保列已在数据源或指标注册表中；或在表达式中现场计算。  
- **scope 无效**：检查格式是否为 `COUNT>=k`/`CONSEC>=m`，参数必须为正整数；距离类需 `dist_points`。  
- **门槛不生效**：确认写在 `gate/trigger/require` 中，默认 `scope="LAST"`，必要时显式声明。  
- **早期样本异常**：指标有 warmup 遮挡，前几行可能为 `None`；策略窗口需覆盖有效数据段。  
- **性能问题**：减少不必要的指标列，合并条件；复用场景缓存（predict_core）。

## 11. 工具

- **规则编辑器**（`score_ui.py` → “规则编辑辅助工具”）：可视化配置、字段校验、表达式检查、生成 JSON、规则解释，支持 RANKING/FILTER/PREDICTION/POSITION/OPPORTUNITY。  
- **策略语法检查器**：自动扫描 `strategies_repo.py`，校验必填字段、类型、scope/dist_points 格式、表达式、缺失列、废弃字段，输出错误/警告/建议。

## 12. 近期更新

- `score_windows` 取代 `window`。  
- `gate/trigger/require` 等价，可任选；`scope` 新增 `COUNT>=k`、`CONSEC>=m`、`RECENT/DIST/NEAR`、`ANY_n/ALL_n`。  
- `dist_points` 支持三元组或对象；标签函数支持自定义标签系列 `CUSTOM_TAGS`。  
- 指标注册增加 warmup 与精度控制，TDX 失败自动回退 Python。***
