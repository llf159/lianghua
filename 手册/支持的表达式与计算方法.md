# 表达式与计算方法参考

适用于评分/回测/预测/模拟的通达信风格表达式。内容涵盖变量注入、指标注册、标签函数、DIFF/KDJ 工具、运算符映射、解析流程与示例。配合 `indicators.py`、`tdx_compat.py`、`scoring_core.py`、`predict_core.py` 一起理解。

## 1. 变量与别名

- **自动注入 DataFrame 列**：数值列自动进入上下文，提供原名/小写/大写三种写法。  
  - 示例：列 `close` 可写 `close/Close/CLOSE`。  
- **价格别名**：`O=open`、`H=high`、`L=low`、`C=close`、`V=vol`、`AMOUNT=amount`。  
- **KDJ 兜底**：`j/k/d` 会尝试匹配列（`j/k/d/kdj_j/kdj_k/kdj_d` 等），缺失时调用 `_fallback_kdj` 现场计算。  
- **上下文变量**：`TS/ts_code`（股票代码）、`REF_DATE/ref_date`（参考日）。  
- **自定义注入**：`tdx.EXTRA_CONTEXT` 可注入任意变量/函数；`CUSTOM_TAGS` 支持自定义标签布尔序列。

## 2. 指标注册表（indicators.py:REGISTRY）

| 名称 | 输出列 | 计算 | 兜底 | warmup | 说明 |
| --- | --- | --- | --- | --- | --- |
| `kdj` | `j` | TDX RSV→SMA→J | `kdj(df)` | 10 | KDJ 指标 |
| `volume_ratio` | `vr` | `V/MA(V,20)` | `volume_ratio(df,n=20)` | 20 | 量比 |
| `volume_ratio_prev` | `vr_prev` | `V/REF(V,1)` | `volume_ratio_prev(df,n=20)` | 2 | 昨量比 |
| `bbi` | `bbi` | `(MA(C,3)+MA(C,6)+MA(C,12)+MA(C,24))/4` | `bbi(df)` | 24 | 多空指数 |
| `rsi` | `rsi` | 12 日 RSI | `rsi(df['close'],period=12)` | 12 | RSI |
| `DIFF` | `diff` | `EMA(C,12)-EMA(C,26)` | `macd_diff(df['close'])` | 26 | MACD DIFF |

特性：TDX 计算失败自动回退 Python；前 warmup 行置 None；按 `out` 小数位 round。新增指标需补充 `name/out/tdx/py_func/kwargs/tags/warmup`。

## 3. 标签函数

- `ANY_TAG(pattern, shift=0)`：匹配列名或 `CUSTOM_TAGS`，将所有匹配列布尔 OR 聚合，可位移。  
- `TAG_HITS(pattern, shift=0)`：命中计数。  
- `ANY_TAG_AT_LEAST(pattern, k, shift=0)`：命中次数至少 k。  
- 便捷昨日版：`YDAY_ANY_TAG`、`YDAY_TAG_HITS`、`YDAY_ANY_TAG_AT_LEAST`。  
示例：`ANY_TAG("突破")`、`TAG_HITS("涨停")>=2`、`ANY_TAG_AT_LEAST("高亮",2)`。

## 4. 运算符与语法

- 逻辑：`AND/OR/NOT`（也支持 `&&/||/!`），会映射为 `&/|/~` 做向量化；比较子句会自动加括号，避免优先级问题。  
- 比较：`== != < <= > >=`；`=` 自动转 `==`。  
- 算术：`+ - * /`。  
- 多语句：用分号 `;` 赋值，最后一条返回值：`HH:=HHV(H,20); SIG:=(C>HH) AND V>MA(V,20); SIG;`

## 5. 内置/扩展函数速览

- 常规：`REF/MA/EMA/SMA/SUM/HHV/LLV/STD/ABS/MAX/MIN/IF/COUNT/CROSS/BARSLAST/SAFE_DIV`。  
- 排名/百分位：`TS_RANK(x,n)`（1..n，1 最小），`TS_PCT(x,n)`（0..1）。  
- DIFF/价格求解：`GET_LAST_DIFF_HIGH_PRICE(lookback=60)`、`GET_LAST_DIFF_HIGH_VALUE(lookback=60)`、`REVERSE_PRICE_TO_DIFF(target_diff, method="optimize|binary_search|grid_search")`。  
- KDJ 查找：`FIND_LAST_LOWEST_J(threshold=13, lookback=100)`。  
- 条件查找：`GET_LAST_CONDITION_PRICE(expr, lookback=100)`。  
- 标签系列：第 3 节函数。

## 6. 上下文与解析流程

1) **构造上下文**：从 DataFrame 提取数值列并创建大小写别名；加入价格别名；合并 EXTRA_CONTEXT/标签；确保 KDJ 别名可用。  
2) **替换阶段**：变量映射、函数映射、逻辑符替换、等号替换、比较子句括号保护。  
3) **指标扫描**：`scoring_core._scan_cols_from_expr` 自动扫描表达式，加载 REGISTRY 输出列。  
4) **执行**：`eval` 在向量化上下文执行，结果缓存编译版本。  
5) **返回**：返回布尔/数值序列；评分时再按 scope 统计。

## 7. 常用表达式示例

```tdx
# 基础
C > O
C > MA(C, 20) AND V > 1.5*MA(V, 20)
H - L > C * 0.02

# 排名/百分位
TS_RANK(C, 60) <= 5
TS_PCT(V, 20) > 0.9

# 标签
ANY_TAG("突破") AND C > MA(C, 20)
TAG_HITS("涨停", shift=0) >= 2

# DIFF/KDJ/条件
C > GET_LAST_DIFF_HIGH_PRICE(120)
CROSS(MA(C,5), MA(C,20)) AND j < 13
ANY_TAG("涨停") AND C > GET_LAST_CONDITION_PRICE("j<13", 80)
```

## 8. 调试与排查

- 变量不存在：确认数据列或在表达式中直接计算；必要时在 `indicators.py` 注册。  
- 除零风险：使用 `SAFE_DIV`。  
- scope 无效：检查格式（`COUNT>=k`/`CONSEC>=m`/距离类需 `dist_points`）。  
- 早期数据异常：指标 warmup 前若干行置 None，需保证窗口覆盖有效段。  
- 长表达式：拆多语句、配合 `gate/clauses` 分层；在规则编辑器里先验证。  
- 标签匹配：`pattern` 支持正则，注意大小写；自定义标签通过 `CUSTOM_TAGS` 注入。  
- 解析性能：减少无用列引用，复用表达式缓存，避免过深嵌套。
- 数据来源：行情与指标列来自 `download.py` 的下载与计算流程（含 warmup 遮挡）；若缺列需先补数据或现场计算。

## 9. 与策略的对应关系

- RANKING/FILTER/OPPORTUNITY/POSITION 使用 `when`；FILTER 还可用 `hard_penalty/reason`。  
- PREDICTION 使用 `check`（表达式）+ `scenario`（虚拟日配置：价格模式、hl_mode、vol_mode、warmup_days、PerStockOverride）。  
- 规则编辑器与语法检查器都会基于本参考中的字段/函数进行校验。
